<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    
    <title>多机版———docker-compose搭建MongoDB 3.4 分片集群详细步骤 | Horysk 宏睿时空</title>
    
    
        <meta property="og:site_name" content="Horysk 宏睿时空">
    
    
        <meta property="article:author" content="Hory Skone">
    
    
        <link rel="icon" href="/img/favicon.ico">
    
    
<link rel="stylesheet" href="/css/minireset.min.css">

    
<link rel="stylesheet" href="/css/all.min.css">

    
<link rel="stylesheet" href="/css/csshake.min.css">

    
<link rel="stylesheet" href="/css/hljs/lioshi.css">

    
<link rel="stylesheet" href="/css/jquery.fancybox.min.css">

    
<link rel="stylesheet" href="/styl/main.css">

    
<script src="/js/jquery.min.js"></script>

    
<script src="/js/highlight.min.js"></script>

    
<script src="/js/jquery.fancybox.min.js"></script>

    
<script src="/js/clipboard.min.js"></script>

<meta name="generator" content="Hexo 5.2.0"></head>
<body>
    <header>
  <div class="outer">
    <div class="inner">
      <h1 class="logo-wrap">
        <a>Horysk 宏睿时空<b><sup>8.8.8</sup></b></a>
      </h1>
    </div>
    <div class="inner">
      <nav class="main-nav">
        
          <a href="/">首页</a>
        
          <a href="/archives">归档</a>
        
          <a href="/categories">分类</a>
        
          <a href="/tags">标签</a>
        
          <a href="/friends">友链</a>
        
          <a href="/about">关于</a>
        
          <a href="https://www.hory-ai.com">HORYAI</a>
        
      </nav>
    </div>
  </div>
</header>
    <div class="content">
        <section class="outer">
    <article>
        <div class="article-title">
    <h2>
        <a href="/2020/07/30/35105/" class="shake shake-little" title="多机版———docker-compose搭建MongoDB 3.4 分片集群详细步骤">
            
            多机版———docker-compose搭建MongoDB 3.4 分片集群详细步骤
        </a>
    </h2>
    <div class="meta_box">
    
        
        
            
                
        
        <div class="meta meta_auth">
            <img src="/img/default.png" alt="head" />
            <p>anonymous</p>
        </div>
    
        
            <div class="meta meta_cate">
                <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
                <p><a class="article-category-link" href="/categories/mongo/">mongo</a>►<a class="article-category-link" href="/categories/mongo/docker/">docker</a></p>
            </div>
        
        
        <div class="meta meta_date">
            <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
            <p>发布于：2020年07月30日</p>
        </div>
    
        <div class="meta meta_update">
            <i class="fas fa-edit fa-fw" aria-hidden="true"></i>
            <p>更新于：2020年07月30日</p>
        </div>
    </div>
    
  <div class="post_tags">
    <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/" rel="tag"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mongo/" rel="tag"><i class="fas fa-hashtag fa-fw" aria-hidden="true"></i>mongo</a></li></ul>
  </div>


</div>

        <hr>
        <div class="article-entry">
            
            
            
            <h2 id="服务器三台-按顺序执行"><a href="#服务器三台-按顺序执行" class="headerlink" title="服务器三台  按顺序执行"></a>服务器三台  按顺序执行</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.125</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.126</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.1</span><span class="number">.127</span></span><br></pre></td></tr></table></figure>
<h2 id="创建目录"><a href="#创建目录" class="headerlink" title="创建目录"></a>创建目录</h2><p>在每台机器上操作此步骤</p>
<a id="more"></a>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cd /home/seeyii</span><br><span class="line">mkdir mongoCluster</span><br><span class="line">cd mongoCluster</span><br></pre></td></tr></table></figure>
<h3 id="vi-mongod-conf"><a href="#vi-mongod-conf" class="headerlink" title="vi mongod.conf"></a>vi mongod.conf</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">storage:</span><br><span class="line">  dbPath: /data/db</span><br><span class="line">  journal:</span><br><span class="line">    enabled: true</span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: true</span><br><span class="line">  path: /var/log/mongodb/mongod.log</span><br><span class="line"></span><br><span class="line">net:</span><br><span class="line">  maxIncomingConnections: <span class="number">10000</span></span><br><span class="line">replication:</span><br><span class="line">  oplogSizeMB: <span class="number">10240</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># security:</span></span><br><span class="line">  <span class="comment"># keyFile: /data/mongodb/key.file</span></span><br><span class="line">  <span class="comment"># authorization: enabled</span></span><br></pre></td></tr></table></figure>
<h3 id="vi-mongos-conf"><a href="#vi-mongos-conf" class="headerlink" title="vi mongos.conf"></a>vi mongos.conf</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">storage:</span><br><span class="line">  dbPath: /data/db</span><br><span class="line">  journal:</span><br><span class="line">    enabled: true</span><br><span class="line">systemLog:</span><br><span class="line">  destination: file</span><br><span class="line">  logAppend: true</span><br><span class="line">  path: /var/log/mongodb/mongos.log</span><br><span class="line"></span><br><span class="line">net:</span><br><span class="line">  maxIncomingConnections: <span class="number">10000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># security:</span></span><br><span class="line">  <span class="comment"># keyFile: /data/mongodb/key.file</span></span><br></pre></td></tr></table></figure>
<h2 id="创建目录-1"><a href="#创建目录-1" class="headerlink" title="创建目录"></a>创建目录</h2><h3 id="vi-first-mkdir-sh"><a href="#vi-first-mkdir-sh" class="headerlink" title="vi first_mkdir.sh"></a>vi first_mkdir.sh</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /database/vol/conf/config</span><br><span class="line">mkdir -p /database/vol/conf/db</span><br><span class="line">mkdir -p /database/vol/shard1/config</span><br><span class="line">mkdir -p /database/vol/shard1/db</span><br><span class="line">mkdir -p /database/vol/shard1/backup</span><br><span class="line">mkdir -p /database/vol/shard2/config</span><br><span class="line">mkdir -p /database/vol/shard2/db</span><br><span class="line">mkdir -p /database/vol/shard2/backup</span><br><span class="line">mkdir -p /database/vol/mongos/config</span><br><span class="line">mkdir -p /database/vol/mongos/db</span><br></pre></td></tr></table></figure>
<h3 id="生成认证文件-root-用户-三台共用一个"><a href="#生成认证文件-root-用户-三台共用一个" class="headerlink" title="生成认证文件 root 用户 三台共用一个"></a>生成认证文件 root 用户 三台共用一个</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -base64 <span class="number">741</span> &gt; key.file</span><br><span class="line">chmod <span class="number">600</span> key.file</span><br><span class="line">chown <span class="number">999</span> key.file</span><br><span class="line">mv key.file /database/vol</span><br></pre></td></tr></table></figure>


<h3 id="将配置文件放到指定位置"><a href="#将配置文件放到指定位置" class="headerlink" title="将配置文件放到指定位置"></a>将配置文件放到指定位置</h3><p>vi second_mv.sh</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"><span class="keyword">for</span> item <span class="keyword">in</span> /database/vol/</span><br><span class="line"> do</span><br><span class="line">   <span class="keyword">for</span> item2 <span class="keyword">in</span> `ls $item`</span><br><span class="line">    do</span><br><span class="line">     <span class="keyword">if</span> [ $item2 = <span class="string">&#x27;mongos&#x27;</span> ]</span><br><span class="line">     then</span><br><span class="line">        echo $item2</span><br><span class="line">        cp mongos.conf $item$item2/config/mongos.conf</span><br><span class="line">     <span class="keyword">else</span></span><br><span class="line">        echo <span class="string">&quot;no&quot;</span></span><br><span class="line">        cp mongod.conf $item$item2/config/mongod.conf</span><br><span class="line">    fi</span><br><span class="line">    done</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<h2 id="docker-compose-yaml-容器编排"><a href="#docker-compose-yaml-容器编排" class="headerlink" title="docker-compose.yaml 容器编排"></a>docker-compose.yaml 容器编排</h2><p>将文件放在 mongoCluster目录中</p>
<h2 id="docker-compose-文件"><a href="#docker-compose-文件" class="headerlink" title="docker-compose 文件"></a>docker-compose 文件</h2><p>docker-compose.yaml</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  rs_config_server:</span><br><span class="line">    image: mongo:<span class="number">3.4</span>  <span class="comment">#  可以不用设置版本,注意参考方案二</span></span><br><span class="line">    command: mongod -f /etc/mongod/mongod.conf --configsvr --replSet <span class="string">&quot;rs-config-server&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /database/vol/key.file:/data/mongodb/key.file</span><br><span class="line">      - /database/vol/conf/config:/etc/mongod</span><br><span class="line">      - /database/vol/conf/db:/data/db</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;10021:27019&quot;</span></span><br><span class="line">    restart:</span><br><span class="line">      always</span><br><span class="line">    container_name:</span><br><span class="line">      rs_config_server</span><br><span class="line">    ulimits:</span><br><span class="line">      nofile:</span><br><span class="line">        soft: <span class="number">300000</span></span><br><span class="line">        hard: <span class="number">300000</span></span><br><span class="line"></span><br><span class="line">  rs_shard_server1:</span><br><span class="line">    image: mongo:<span class="number">3.4</span></span><br><span class="line">    command: mongod -f /etc/mongod/mongod.conf --directoryperdb --shardsvr --replSet <span class="string">&quot;rs-shard1-server&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /database/vol/key.file:/data/mongodb/key.file</span><br><span class="line">      - /database/vol/shard1/config:/etc/mongod</span><br><span class="line">      - /database/vol/shard1/db:/data/db</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;10031:27018&quot;</span></span><br><span class="line">    restart:</span><br><span class="line">      always</span><br><span class="line">    container_name:</span><br><span class="line">      rs_shard_server1</span><br><span class="line">    ulimits:</span><br><span class="line">      nofile:</span><br><span class="line">        soft: <span class="number">300000</span></span><br><span class="line">        hard: <span class="number">300000</span></span><br><span class="line"></span><br><span class="line">  rs_shard_server2:</span><br><span class="line">    image: mongo:<span class="number">3.4</span></span><br><span class="line">    command: mongod -f /etc/mongod/mongod.conf --directoryperdb --shardsvr --replSet <span class="string">&quot;rs-shard2-server&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /database/vol/key.file:/data/mongodb/key.file</span><br><span class="line">      - /database/vol/shard2/config:/etc/mongod</span><br><span class="line">      - /database/vol/shard2/db:/data/db</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;10041:27018&quot;</span></span><br><span class="line">    restart:</span><br><span class="line">      always</span><br><span class="line">    container_name:</span><br><span class="line">      rs_shard_server2</span><br><span class="line">    ulimits:</span><br><span class="line">      nofile:</span><br><span class="line">        soft: <span class="number">300000</span></span><br><span class="line">        hard: <span class="number">300000</span></span><br><span class="line"></span><br><span class="line">  rs_mongos_server:</span><br><span class="line">    image: mongo:<span class="number">3.4</span></span><br><span class="line">    command:   --configdb rs-config-server/<span class="number">192.168</span><span class="number">.1</span><span class="number">.125</span>:<span class="number">10021</span>,<span class="number">192.168</span><span class="number">.1</span><span class="number">.126</span>:<span class="number">10021</span>,<span class="number">192.168</span><span class="number">.1</span><span class="number">.127</span>:<span class="number">10021</span>  --bind_ip_all</span><br><span class="line">    ports:</span><br><span class="line">      - <span class="string">&quot;10011:27017&quot;</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /database/vol/key.file:/data/mongodb/key.file</span><br><span class="line">      - /database/vol/mongos/config:/etc/mongod</span><br><span class="line">      - /database/vol/mongos/db:/data/db</span><br><span class="line">    entrypoint: mongos</span><br><span class="line">    restart:</span><br><span class="line">      always</span><br><span class="line">    container_name:</span><br><span class="line">      rs_mongos_server</span><br><span class="line">    ulimits:</span><br><span class="line">      nofile:</span><br><span class="line">        soft: <span class="number">300000</span></span><br><span class="line">        hard: <span class="number">300000</span></span><br></pre></td></tr></table></figure>
<h3 id="启动-docker-compose-up-d"><a href="#启动-docker-compose-up-d" class="headerlink" title="启动 docker-compose up -d"></a>启动 docker-compose up -d</h3><h1 id="添加副本集"><a href="#添加副本集" class="headerlink" title="添加副本集"></a>添加副本集</h1><h2 id="配置服务器"><a href="#配置服务器" class="headerlink" title="配置服务器"></a>配置服务器</h2><p>连接任意一个节点 mongo –host 192.168.1.125 –port 10021</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">rs.initiate(&#123;</span><br><span class="line">		    _id: <span class="string">&quot;rs-config-server&quot;</span>,</span><br><span class="line">		    configsvr: true,</span><br><span class="line">		    members: [</span><br><span class="line">		    	&#123; _id : <span class="number">0</span>, host : <span class="string">&quot;192.168.1.125:10021&quot;</span> &#125;,</span><br><span class="line">		        &#123; _id : <span class="number">1</span>, host : <span class="string">&quot;192.168.1.126:10021&quot;</span> &#125;,</span><br><span class="line">		        &#123; _id : <span class="number">2</span>, host : <span class="string">&quot;192.168.1.127:10021&quot;</span> &#125;,</span><br><span class="line">		    ]</span><br><span class="line">		&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="分片1"><a href="#分片1" class="headerlink" title="分片1"></a>分片1</h2><p>连接任意一个节点 mongo –host 192.168.1.125 –port 10031</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rs.initiate(&#123;</span><br><span class="line">		    _id: <span class="string">&quot;rs-shard1-server&quot;</span>,</span><br><span class="line">		    members: [</span><br><span class="line">		    	&#123; _id : <span class="number">0</span>, host : <span class="string">&quot;192.168.1.125:10031&quot;</span> &#125;,</span><br><span class="line">		        &#123; _id : <span class="number">1</span>, host : <span class="string">&quot;192.168.1.126:10031&quot;</span> &#125;,</span><br><span class="line">		        &#123; _id : <span class="number">2</span>, host : <span class="string">&quot;192.168.1.127:10031&quot;</span> &#125;,</span><br><span class="line">		    ]</span><br><span class="line">		&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="分片2"><a href="#分片2" class="headerlink" title="分片2"></a>分片2</h2><p>连接任意一个节点 mongo –host 192.168.1.125 –port 10041</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rs.initiate(&#123;</span><br><span class="line">		    _id: <span class="string">&quot;rs-shard2-server&quot;</span>,</span><br><span class="line">		    members: [</span><br><span class="line">		    	&#123; _id : <span class="number">0</span>, host : <span class="string">&quot;192.168.1.125:10041&quot;</span> &#125;,</span><br><span class="line">		        &#123; _id : <span class="number">1</span>, host : <span class="string">&quot;192.168.1.126:10041&quot;</span> &#125;,</span><br><span class="line">		        &#123; _id : <span class="number">2</span>, host : <span class="string">&quot;192.168.1.127:10041&quot;</span> &#125;,</span><br><span class="line">		    ]</span><br><span class="line">		&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="配置mongos"><a href="#配置mongos" class="headerlink" title="配置mongos"></a>配置mongos</h2><p>确保mongos服务起来之后，连接到192.168.1.125:10011执行以下命令添加分片服务器信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh.addShard(<span class="string">&quot;rs-shard1-server/192.168.1.125:10031,192.168.1.126:10031,192.168.1.127:10031&quot;</span>)</span><br><span class="line">sh.addShard(<span class="string">&quot;rs-shard2-server/192.168.1.125:10041,192.168.1.126:10041,192.168.1.127:10041&quot;</span>)</span><br></pre></td></tr></table></figure>
<h2 id="添加用户认证"><a href="#添加用户认证" class="headerlink" title="添加用户认证"></a>添加用户认证</h2><p>连接任意的mongos</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">use admin</span><br><span class="line"></span><br><span class="line">db.createUser(</span><br><span class="line">		    &#123;</span><br><span class="line">		        user:<span class="string">&quot;root&quot;</span>,</span><br><span class="line">		        pwd:<span class="string">&quot;shiye1805A&quot;</span>,</span><br><span class="line">		        roles:[&#123;role:<span class="string">&quot;root&quot;</span>,db:<span class="string">&quot;admin&quot;</span>&#125;]</span><br><span class="line">		    &#125;</span><br><span class="line">		)</span><br></pre></td></tr></table></figure>
<h2 id="验证是否创建成功"><a href="#验证是否创建成功" class="headerlink" title="验证是否创建成功"></a>验证是否创建成功</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.auth(<span class="string">&#x27;root&#x27;</span>,<span class="string">&#x27;shiye1805A&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>返回值 1 成功</p>
<p>将配置文件的用户认证全部打开 security:</p>
<p>重启容器 注意： 保证key.file 权限为 999</p>
<h2 id="容器-操作"><a href="#容器-操作" class="headerlink" title="容器 操作"></a>容器 操作</h2><h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>docker rm -f rs_mongos_server rs_config_server rs_shard_server1 rs_shard_server2</p>
<h3 id="停止"><a href="#停止" class="headerlink" title="停止"></a>停止</h3><p>docker stop rs_mongos_server rs_config_server rs_shard_server1 rs_shard_server2</p>
<h3 id="重启"><a href="#重启" class="headerlink" title="重启"></a>重启</h3><p>docker restart rs_mongos_server rs_config_server rs_shard_server1 rs_shard_server2</p>
<h3 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h3><p>docker start rs_mongos_server rs_config_server rs_shard_server1 rs_shard_server2</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43886133/article/details/95332931">link</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/yufei_java/article/details/103704582">docker-compose搭建mongodb分片集群及安全身份认证（实战）</a></p>
<p> 最近由于项目中设计中有使用mongodb，具体mongodb的优点我就不多说。这篇文章主要是分享下我通过docker-compose搭建mongodb分片集群，并实现安全身份认证访问(mongodb安装后默认是不需要用户名和密码访问的)。</p>
<h2 id="下面是我配置的docker-compose-yml文件："><a href="#下面是我配置的docker-compose-yml文件：" class="headerlink" title="下面是我配置的docker-compose.yml文件："></a>下面是我配置的docker-compose.yml文件：</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  shard_server01:</span><br><span class="line">    container_name: shard_server01</span><br><span class="line">    image: mongo:<span class="number">3.6</span></span><br><span class="line">    networks:</span><br><span class="line">      mongo:</span><br><span class="line">        ipv4_address: <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="number">27018</span>:<span class="number">27018</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /data/docker/mongos/data/shard_server01/data/db:/data/db</span><br><span class="line">      - /data/docker/mongos/data/shard_server01/data/configdb:/data/configdb</span><br><span class="line">      - /data/docker/mongos/data/shard_server01/data/backup:/data/backup</span><br><span class="line">      - /data/docker/mongos/data/mongod.conf:/etc/mongod.conf</span><br><span class="line">      - /data/docker/mongos/data/key.file:/etc/key.file</span><br><span class="line">    command: --shardsvr --bind_ip_all</span><br><span class="line">    restart: always</span><br><span class="line">    depends_on:</span><br><span class="line">      - rs_config_server01</span><br><span class="line">      - rs_config_server02</span><br><span class="line">    ulimits:</span><br><span class="line">      nofile:</span><br><span class="line">        soft: <span class="number">300000</span></span><br><span class="line">        hard: <span class="number">300000</span></span><br><span class="line">  shard_server02:</span><br><span class="line">    container_name: shard_server02</span><br><span class="line">    image: mongo:<span class="number">3.6</span></span><br><span class="line">    networks:</span><br><span class="line">      mongo:</span><br><span class="line">        ipv4_address: <span class="number">192.168</span><span class="number">.1</span><span class="number">.12</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="number">27028</span>:<span class="number">27018</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /data/docker/mongos/data/shard_server02/data/db:/data/db</span><br><span class="line">      - /data/docker/mongos/data/shard_server02/data/configdb:/data/configdb</span><br><span class="line">      - /data/docker/mongos/data/shard_server02/data/backup:/data/backup</span><br><span class="line">      - /data/docker/mongos/data/mongod.conf:/etc/mongod.conf</span><br><span class="line">      - /data/docker/mongos/data/key.file:/etc/key.file</span><br><span class="line">    command: --shardsvr --keyFile <span class="string">&quot;/etc/key.file&quot;</span> --bind_ip_all --auth</span><br><span class="line">    restart: always</span><br><span class="line">    depends_on:</span><br><span class="line">      - rs_config_server01</span><br><span class="line">      - rs_config_server02</span><br><span class="line"><span class="comment"># 配置服务器集群两个节点（mongodb3.4之后的版本需要两个config_server）</span></span><br><span class="line">  rs_config_server01:</span><br><span class="line">    container_name: rs_config_server01</span><br><span class="line">    image: mongo:<span class="number">3.6</span></span><br><span class="line">    networks:</span><br><span class="line">      mongo:</span><br><span class="line">        ipv4_address: <span class="number">192.168</span><span class="number">.1</span><span class="number">.13</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="number">27019</span>:<span class="number">27019</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /data/docker/mongos/data/rs_config_server01/data/db:/data/db</span><br><span class="line">      - /data/docker/mongos/data/rs_config_server01/data/configdb:/data/configdb</span><br><span class="line">      - /data/docker/mongos/data/rs_config_server01/data/backup:/data/backup</span><br><span class="line">      - /data/docker/mongos/data/mongod.conf:/etc/mongod.conf</span><br><span class="line">      - /data/docker/mongos/data/key.file:/etc/key.file</span><br><span class="line">    command: --configsvr --replSet <span class="string">&quot;rs_config_server&quot;</span> --bind_ip_all</span><br><span class="line">    restart: always</span><br><span class="line"> </span><br><span class="line">  rs_config_server02:</span><br><span class="line">    container_name: rs_config_server02</span><br><span class="line">    image: mongo:<span class="number">3.6</span></span><br><span class="line">    networks:</span><br><span class="line">      mongo:</span><br><span class="line">        ipv4_address: <span class="number">192.168</span><span class="number">.1</span><span class="number">.14</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="number">27029</span>:<span class="number">27019</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /data/docker/mongos/data/rs_config_server02/data/db:/data/db</span><br><span class="line">      - /data/docker/mongos/data/rs_config_server02/data/configdb:/data/configdb</span><br><span class="line">      - /data/docker/mongos/data/rs_config_server02/data/backup:/data/backup</span><br><span class="line">      - /data/docker/mongos/data/mongod.conf:/etc/mongod.conf</span><br><span class="line">      - /data/docker/mongos/data/key.file:/etc/key.file</span><br><span class="line">    command: --configsvr --replSet <span class="string">&quot;rs_config_server&quot;</span> --bind_ip_all</span><br><span class="line">    restart: always</span><br><span class="line"> </span><br><span class="line">    </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 路由节点mongos</span></span><br><span class="line">  mongos:</span><br><span class="line">    container_name: mongos</span><br><span class="line">    networks:</span><br><span class="line">      mongo:</span><br><span class="line">        ipv4_address: <span class="number">192.168</span><span class="number">.1</span><span class="number">.15</span></span><br><span class="line">    image: mongo:<span class="number">3.6</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="number">27017</span>:<span class="number">27017</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /data/docker/mongos/data/data/db:/data/db</span><br><span class="line">      - /data/docker/mongos/data/data/configdb:/data/configdb</span><br><span class="line">      - /data/docker/mongos/data/data/backup:/data/backup</span><br><span class="line">      - /data/docker/mongos/data/mongod.conf:/etc/mongod.conf</span><br><span class="line">      - /data/docker/mongos/data/key.file:/etc/key.file</span><br><span class="line">    entrypoint: mongos</span><br><span class="line">    command: --configdb rs_config_server/<span class="number">192.168</span><span class="number">.1</span><span class="number">.13</span>:<span class="number">27019</span>,<span class="number">192.168</span><span class="number">.1</span><span class="number">.14</span>:<span class="number">27019</span> --bind_ip_all</span><br><span class="line">    depends_on:</span><br><span class="line">      - shard_server01</span><br><span class="line">      - shard_server02</span><br><span class="line"> </span><br><span class="line">networks:</span><br><span class="line">    mongo:</span><br><span class="line">        driver: bridge</span><br><span class="line">        ipam:</span><br><span class="line">            config:</span><br><span class="line">                - subnet: <span class="number">192.168</span><span class="number">.1</span><span class="number">.10</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure>
<h3 id="注意：目前是没有增加安全身份认证的。"><a href="#注意：目前是没有增加安全身份认证的。" class="headerlink" title="注意：目前是没有增加安全身份认证的。"></a>注意：目前是没有增加安全身份认证的。</h3><h2 id="使用docker-compose启动mongo集群"><a href="#使用docker-compose启动mongo集群" class="headerlink" title="使用docker-compose启动mongo集群"></a>使用docker-compose启动mongo集群</h2><p>docker-compose up -d</p>
<h3 id="配置服务器设置（config-server）"><a href="#配置服务器设置（config-server）" class="headerlink" title="配置服务器设置（config_server）"></a>配置服务器设置（config_server）</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it rs_config_server01 /<span class="built_in">bin</span>/bash</span><br><span class="line">mongo --host localhost --port <span class="number">27019</span></span><br><span class="line">rs.initiate(&#123;</span><br><span class="line">    _id: <span class="string">&quot;rs_config_server&quot;</span>,</span><br><span class="line">    configsvr: true,</span><br><span class="line">    members: [</span><br><span class="line">        &#123; _id : <span class="number">0</span>, host : <span class="string">&quot;192.168.1.13:27019&quot;</span> &#125;,</span><br><span class="line">        &#123; _id : <span class="number">1</span>, host : <span class="string">&quot;192.168.1.14:27019&quot;</span> &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>配置路由mongos服务</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mongos /<span class="built_in">bin</span>/bash</span><br><span class="line">mongo --port <span class="number">27017</span></span><br></pre></td></tr></table></figure>
<p>将分片集群添加到mongos中</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sh.addShard(<span class="string">&quot;192.168.1.11:27018&quot;</span>)</span><br><span class="line">sh.addShard(<span class="string">&quot;192.168.1.12:27018&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>到目前为止，mongodb分片集群已经搭建完毕。但是mongdb默认是无需账户即可直接访问。故，若是需要增加账号和密码，并强制需要输入正确的账户和密码才能登陆的话，看下文。</p>
<h2 id="1、创建mongdb的账户和密码"><a href="#1、创建mongdb的账户和密码" class="headerlink" title="1、创建mongdb的账户和密码"></a>1、创建mongdb的账户和密码</h2><p>进入mongos路由服务</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker <span class="built_in">exec</span> -it mongos /<span class="built_in">bin</span>/bash</span><br><span class="line">mongo --port <span class="number">27017</span></span><br></pre></td></tr></table></figure>
<p> 切换到admin库，创建用户root</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">use admin</span><br><span class="line"> </span><br><span class="line">db.createUser(</span><br><span class="line">		    &#123;</span><br><span class="line">		        user:<span class="string">&quot;root&quot;</span>,</span><br><span class="line">		        pwd:<span class="string">&quot;123456&quot;</span>,</span><br><span class="line">		        roles:[&#123;role:<span class="string">&quot;root&quot;</span>,db:<span class="string">&quot;admin&quot;</span>&#125;]</span><br><span class="line">		    &#125;</span><br><span class="line">		)</span><br></pre></td></tr></table></figure>
<h2 id="2、生成mongo节点之前通讯认证文件（key-file）"><a href="#2、生成mongo节点之前通讯认证文件（key-file）" class="headerlink" title="2、生成mongo节点之前通讯认证文件（key.file）"></a>2、生成mongo节点之前通讯认证文件（key.file）</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">openssl rand -base64 <span class="number">741</span> &gt; key.file</span><br><span class="line">chmod <span class="number">600</span> key.file</span><br><span class="line">chown <span class="number">999</span> key.file </span><br></pre></td></tr></table></figure>
<h2 id="3、将key-file挂载docker容器里面，启动命令指定key-file，并增加需要认证-–auth"><a href="#3、将key-file挂载docker容器里面，启动命令指定key-file，并增加需要认证-–auth" class="headerlink" title="3、将key.file挂载docker容器里面，启动命令指定key.file，并增加需要认证(–auth)"></a>3、将key.file挂载docker容器里面，启动命令指定key.file，并增加需要认证(–auth)</h2><p>  增加安全认证之后的docker-compose .yml文件如下</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">version: <span class="string">&#x27;2&#x27;</span></span><br><span class="line">services:</span><br><span class="line">  shard_server01:</span><br><span class="line">    container_name: shard_server01</span><br><span class="line">    image: mongo:<span class="number">3.6</span></span><br><span class="line">    networks:</span><br><span class="line">      mongo:</span><br><span class="line">        ipv4_address: <span class="number">192.168</span><span class="number">.1</span><span class="number">.11</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="number">27018</span>:<span class="number">27018</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /data/docker/mongos/data/shard_server01/data/db:/data/db</span><br><span class="line">      - /data/docker/mongos/data/shard_server01/data/configdb:/data/configdb</span><br><span class="line">      - /data/docker/mongos/data/shard_server01/data/backup:/data/backup</span><br><span class="line">      - /data/docker/mongos/data/mongod.conf:/etc/mongod.conf</span><br><span class="line">      - /data/docker/mongos/data/key.file:/etc/key.file</span><br><span class="line">    command: --shardsvr --keyFile <span class="string">&quot;/etc/key.file&quot;</span> --bind_ip_all --auth</span><br><span class="line">    restart: always</span><br><span class="line">    depends_on:</span><br><span class="line">      - rs_config_server01</span><br><span class="line">      - rs_config_server02</span><br><span class="line">    ulimits:</span><br><span class="line">      nofile:</span><br><span class="line">        soft: <span class="number">300000</span></span><br><span class="line">        hard: <span class="number">300000</span></span><br><span class="line">  shard_server02:</span><br><span class="line">    container_name: shard_server02</span><br><span class="line">    image: mongo:<span class="number">3.6</span></span><br><span class="line">    networks:</span><br><span class="line">      mongo:</span><br><span class="line">        ipv4_address: <span class="number">192.168</span><span class="number">.1</span><span class="number">.12</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="number">27028</span>:<span class="number">27018</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /data/docker/mongos/data/shard_server02/data/db:/data/db</span><br><span class="line">      - /data/docker/mongos/data/shard_server02/data/configdb:/data/configdb</span><br><span class="line">      - /data/docker/mongos/data/shard_server02/data/backup:/data/backup</span><br><span class="line">      - /data/docker/mongos/data/mongod.conf:/etc/mongod.conf</span><br><span class="line">      - /data/docker/mongos/data/key.file:/etc/key.file</span><br><span class="line">    command: --shardsvr --keyFile <span class="string">&quot;/etc/key.file&quot;</span> --bind_ip_all --auth</span><br><span class="line">    restart: always</span><br><span class="line">    depends_on:</span><br><span class="line">      - rs_config_server01</span><br><span class="line">      - rs_config_server02</span><br><span class="line"><span class="comment"># 配置服务器集群两个节点（mongodb3.4之后的版本需要两个config_server）</span></span><br><span class="line">  rs_config_server01:</span><br><span class="line">    container_name: rs_config_server01</span><br><span class="line">    image: mongo:<span class="number">3.6</span></span><br><span class="line">    networks:</span><br><span class="line">      mongo:</span><br><span class="line">        ipv4_address: <span class="number">192.168</span><span class="number">.1</span><span class="number">.13</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="number">27019</span>:<span class="number">27019</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /data/docker/mongos/data/rs_config_server01/data/db:/data/db</span><br><span class="line">      - /data/docker/mongos/data/rs_config_server01/data/configdb:/data/configdb</span><br><span class="line">      - /data/docker/mongos/data/rs_config_server01/data/backup:/data/backup</span><br><span class="line">      - /data/docker/mongos/data/mongod.conf:/etc/mongod.conf</span><br><span class="line">      - /data/docker/mongos/data/key.file:/etc/key.file</span><br><span class="line">    command: --configsvr --keyFile <span class="string">&quot;/etc/key.file&quot;</span> --replSet <span class="string">&quot;rs_config_server&quot;</span> --bind_ip_all --auth</span><br><span class="line">    restart: always</span><br><span class="line"> </span><br><span class="line">  rs_config_server02:</span><br><span class="line">    container_name: rs_config_server02</span><br><span class="line">    image: mongo:<span class="number">3.6</span></span><br><span class="line">    networks:</span><br><span class="line">      mongo:</span><br><span class="line">        ipv4_address: <span class="number">192.168</span><span class="number">.1</span><span class="number">.14</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="number">27029</span>:<span class="number">27019</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /data/docker/mongos/data/rs_config_server02/data/db:/data/db</span><br><span class="line">      - /data/docker/mongos/data/rs_config_server02/data/configdb:/data/configdb</span><br><span class="line">      - /data/docker/mongos/data/rs_config_server02/data/backup:/data/backup</span><br><span class="line">      - /data/docker/mongos/data/mongod.conf:/etc/mongod.conf</span><br><span class="line">      - /data/docker/mongos/data/key.file:/etc/key.file</span><br><span class="line">    command: --configsvr --keyFile <span class="string">&quot;/etc/key.file&quot;</span> --replSet <span class="string">&quot;rs_config_server&quot;</span> --bind_ip_all --auth</span><br><span class="line">    restart: always</span><br><span class="line"> </span><br><span class="line">    </span><br><span class="line"> </span><br><span class="line"><span class="comment"># 路由节点mongos</span></span><br><span class="line">  mongos:</span><br><span class="line">    container_name: mongos</span><br><span class="line">    networks:</span><br><span class="line">      mongo:</span><br><span class="line">        ipv4_address: <span class="number">192.168</span><span class="number">.1</span><span class="number">.15</span></span><br><span class="line">    image: mongo:<span class="number">3.6</span></span><br><span class="line">    ports:</span><br><span class="line">      - <span class="number">27017</span>:<span class="number">27017</span></span><br><span class="line">    volumes:</span><br><span class="line">      - /data/docker/mongos/data/data/db:/data/db</span><br><span class="line">      - /data/docker/mongos/data/data/configdb:/data/configdb</span><br><span class="line">      - /data/docker/mongos/data/data/backup:/data/backup</span><br><span class="line">      - /data/docker/mongos/data/mongod.conf:/etc/mongod.conf</span><br><span class="line">      - /data/docker/mongos/data/key.file:/etc/key.file</span><br><span class="line">    entrypoint: mongos</span><br><span class="line">    command: --configdb rs_config_server/<span class="number">192.168</span><span class="number">.1</span><span class="number">.13</span>:<span class="number">27019</span>,<span class="number">192.168</span><span class="number">.1</span><span class="number">.14</span>:<span class="number">27019</span> --keyFile <span class="string">&quot;/etc/key.file&quot;</span> --bind_ip_all --auth</span><br><span class="line">    depends_on:</span><br><span class="line">      - shard_server01</span><br><span class="line">      - shard_server02</span><br><span class="line"> </span><br><span class="line">networks:</span><br><span class="line">    mongo:</span><br><span class="line">        driver: bridge</span><br><span class="line">        ipam:</span><br><span class="line">            config:</span><br><span class="line">                - subnet: <span class="number">192.168</span><span class="number">.1</span><span class="number">.10</span>/<span class="number">24</span></span><br></pre></td></tr></table></figure>
<h2 id="4、重启docker-compose"><a href="#4、重启docker-compose" class="headerlink" title="4、重启docker-compose"></a>4、重启docker-compose</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">docker-compose down</span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>
<p>到此，增加安全登录已经配置完毕。若不使用账号和密码访问结果如下：</p>

        </div>
        <div class="article-copyright">
            
    <blockquote>
        <p>
            版权声明：本文为「宏睿时空」的原创文章，博客内容遵循 署名-非商业性使用-相同方式共享 协议。<br>本文永久链接是:http://www.hory-ai.com/2020/07/30/35105/
        </p>
    </blockquote>


        </div>
    </article>
    

    <section id="toc-div" >
        <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%89%E5%8F%B0-%E6%8C%89%E9%A1%BA%E5%BA%8F%E6%89%A7%E8%A1%8C"><span class="toc-text">服务器三台  按顺序执行</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95"><span class="toc-text">创建目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vi-mongod-conf"><span class="toc-text">vi mongod.conf</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vi-mongos-conf"><span class="toc-text">vi mongos.conf</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E7%9B%AE%E5%BD%95-1"><span class="toc-text">创建目录</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vi-first-mkdir-sh"><span class="toc-text">vi first_mkdir.sh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E8%AE%A4%E8%AF%81%E6%96%87%E4%BB%B6-root-%E7%94%A8%E6%88%B7-%E4%B8%89%E5%8F%B0%E5%85%B1%E7%94%A8%E4%B8%80%E4%B8%AA"><span class="toc-text">生成认证文件 root 用户 三台共用一个</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B0%86%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E6%94%BE%E5%88%B0%E6%8C%87%E5%AE%9A%E4%BD%8D%E7%BD%AE"><span class="toc-text">将配置文件放到指定位置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker-compose-yaml-%E5%AE%B9%E5%99%A8%E7%BC%96%E6%8E%92"><span class="toc-text">docker-compose.yaml 容器编排</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker-compose-%E6%96%87%E4%BB%B6"><span class="toc-text">docker-compose 文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8-docker-compose-up-d"><span class="toc-text">启动 docker-compose up -d</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E5%89%AF%E6%9C%AC%E9%9B%86"><span class="toc-text">添加副本集</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-text">配置服务器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E7%89%871"><span class="toc-text">分片1</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%86%E7%89%872"><span class="toc-text">分片2</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEmongos"><span class="toc-text">配置mongos</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81"><span class="toc-text">添加用户认证</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%AA%8C%E8%AF%81%E6%98%AF%E5%90%A6%E5%88%9B%E5%BB%BA%E6%88%90%E5%8A%9F"><span class="toc-text">验证是否创建成功</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%B9%E5%99%A8-%E6%93%8D%E4%BD%9C"><span class="toc-text">容器 操作</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4"><span class="toc-text">删除</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%81%9C%E6%AD%A2"><span class="toc-text">停止</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%90%AF"><span class="toc-text">重启</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%AF%E5%8A%A8"><span class="toc-text">启动</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%8B%E9%9D%A2%E6%98%AF%E6%88%91%E9%85%8D%E7%BD%AE%E7%9A%84docker-compose-yml%E6%96%87%E4%BB%B6%EF%BC%9A"><span class="toc-text">下面是我配置的docker-compose.yml文件：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B3%A8%E6%84%8F%EF%BC%9A%E7%9B%AE%E5%89%8D%E6%98%AF%E6%B2%A1%E6%9C%89%E5%A2%9E%E5%8A%A0%E5%AE%89%E5%85%A8%E8%BA%AB%E4%BB%BD%E8%AE%A4%E8%AF%81%E7%9A%84%E3%80%82"><span class="toc-text">注意：目前是没有增加安全身份认证的。</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8docker-compose%E5%90%AF%E5%8A%A8mongo%E9%9B%86%E7%BE%A4"><span class="toc-text">使用docker-compose启动mongo集群</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%9C%8D%E5%8A%A1%E5%99%A8%E8%AE%BE%E7%BD%AE%EF%BC%88config-server%EF%BC%89"><span class="toc-text">配置服务器设置（config_server）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E3%80%81%E5%88%9B%E5%BB%BAmongdb%E7%9A%84%E8%B4%A6%E6%88%B7%E5%92%8C%E5%AF%86%E7%A0%81"><span class="toc-text">1、创建mongdb的账户和密码</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E3%80%81%E7%94%9F%E6%88%90mongo%E8%8A%82%E7%82%B9%E4%B9%8B%E5%89%8D%E9%80%9A%E8%AE%AF%E8%AE%A4%E8%AF%81%E6%96%87%E4%BB%B6%EF%BC%88key-file%EF%BC%89"><span class="toc-text">2、生成mongo节点之前通讯认证文件（key.file）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E3%80%81%E5%B0%86key-file%E6%8C%82%E8%BD%BDdocker%E5%AE%B9%E5%99%A8%E9%87%8C%E9%9D%A2%EF%BC%8C%E5%90%AF%E5%8A%A8%E5%91%BD%E4%BB%A4%E6%8C%87%E5%AE%9Akey-file%EF%BC%8C%E5%B9%B6%E5%A2%9E%E5%8A%A0%E9%9C%80%E8%A6%81%E8%AE%A4%E8%AF%81-%E2%80%93auth"><span class="toc-text">3、将key.file挂载docker容器里面，启动命令指定key.file，并增加需要认证(–auth)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4%E3%80%81%E9%87%8D%E5%90%AFdocker-compose"><span class="toc-text">4、重启docker-compose</span></a></li></ol>
    </section>
    <section id="gohome" style="display: none;"><a>顶</a></section>

    <script>
        function get_top_by_link(link){
            var hnid = "#" + $(link).attr("data");
            if ($(hnid).length > 0){
                return $(hnid).offset().top;
            }else{
                return 0;
            }
        }
        //go to hn
        function gotohn(link){
            $("html,body").animate({scrollTop: get_top_by_link(link) }, 300);
        }
        //页面滚动
        function update(){
            var scrollH = $(window).scrollTop();
            if($(".toc-link")){
                $(".toc-link").each(function(i,link){
                    var mdHeight = get_top_by_link(link);
                    if(mdHeight <= scrollH + 40){
                        //高亮导航菜单
                        $('.toc-link').removeClass('on');
                        $(link).addClass('on');
                    }
                });
            }
            //返回顶部显隐
            if(scrollH < 200){
                $("#gohome").css("display","none");
            }else{
                $("#gohome").css("display","block");
            }
        }
        $(function(){
            //修复部分锚点从属关系
            if($("#toc-div >li").length > 0){
                $("#toc-div >li").appendTo($("#toc-div >ol:first"));
            }
            //返回顶部
            $('#gohome').click(function(){
                $("html,body").animate({scrollTop: 0}, 300);
                return false;
            })
            //遍历锚点
            $(".toc-link").each(function(i,link){
                $(link).attr("data",$(link).attr('href').substring(1));
                $(link).attr("href","javascript:void(0);");
                $(link).attr("onclick","gotohn(this);");
            })
            //绑定滚动事件
            $(window).bind('scroll', update);
            //初始化toc
            var first_toc = $(".toc-link")[0];
            var first_scroll = get_top_by_link(first_toc);
            var window_scroll = $(window).scrollTop();
            if(window_scroll <= first_scroll){
                $(first_toc).addClass('on');
            }
        })
    </script>

</section>
    </div>
    <footer>
    <div class="outer">
        <div class="inner">
            Powered by <a href="http://prowiki.demopage.icu/" target="_blank">ProWiki</a>
            &copy;2020 HORYSK<br>
            <a target="_blank" rel="noopener" href="http://beian.miit.gov.cn/">粤ICP备6896438749号</a>
        </div>
    </div>
</footer>

<script src="/js/custom.js"></script>


    <script>onload_content();</script>

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/z16.model.json"},"display":{"position":"right","width":300,"height":600},"mobile":{"show":true}});</script></body>
</html>
